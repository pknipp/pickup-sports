const express = require('express');
const asyncHandler = require('express-async-handler');
const { Op } = require('sequelize');

const { Sport, Favorite } = require('../../db/models');
const { authenticated } = require('./security-utils');

const router = express.Router();

router.get('/:all', [authenticated], asyncHandler(async(req, res, next) => {
    try {
    let userId = req.user.id;
    let sports = (await Sport.findAll({})).map(sport => sport.dataValues);
    console.log("req.params.all = ", req.params.all)
    if (!req.params.all) {
        const favorites = await Favorite.findAll({where: {userId: user.id}});
        const favoriteSportIds = favorites.map(favorite => favorite.sportId);
        sports.filter(sport => favoriteSportIds.includes(sport.id));
    }
    for (let i = 0; i < sports.length; i++) {
        let sport = sports[i];
        if (req.params.all) {
        sport.Skill = (await Favorite.findOne({where: {userId, sportId: sport.id}})).skill;
        }
        sport.boolTypes = JSON.parse(sport.boolTypes);
        sport.skills = JSON.parse(sport.skills);
    };
    res.json({sports});
} catch(e) {
    console.log(e)
}
}));

module.exports = router;
